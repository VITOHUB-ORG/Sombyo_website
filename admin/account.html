<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sombyo Admin - Account</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{ --sb-blue:#0d6efd; --sb-bg:#f6f8fb; }
    body{ background: var(--sb-bg); }
    .app{ min-height:100vh; }
    .sidebar{ width:260px; background:#0b2557; color:#fff; }
    .sidebar .nav-link{ color:rgba(255,255,255,.86); border-radius:12px; padding:.6rem .75rem; }
    .sidebar .nav-link:hover{ background:rgba(255,255,255,.10); color:#fff; }
    .sidebar .nav-link.active{ background:rgba(13,110,253,.25); color:#fff; }
    .topbar{ background: linear-gradient(90deg, rgba(13,110,253,.95), rgba(11,94,215,.95)); color:#fff; }
    .card-soft{ border:0; border-radius:18px; }
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background:rgba(255,255,255,.2);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
    }
    @media (min-width:992px){
      .sidebar{ position:sticky; top:0; height:100vh; }
      .content-wrap{ padding:22px; }
    }
    .form-control:focus { box-shadow: 0 0 0 .2rem rgba(13,110,253,.2); border-color: rgba(13,110,253,.6); }
  </style>
</head>

<body>
<div class="app d-flex">

  <aside class="sidebar d-none d-lg-block p-3">
    <div class="d-flex align-items-center gap-2 mb-3">
      <div class="p-2 rounded-3" style="background:rgba(255,255,255,.12)">
        <i class="bi bi-gear"></i>
      </div>
      <div>
        <div class="fw-semibold">Sombyo Admin</div>
        <div class="small opacity-75">Account</div>
      </div>
    </div>

    <nav class="nav flex-column gap-1 mt-3">
      <a class="nav-link" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
      <a class="nav-link" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
      <a class="nav-link active" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
    </nav>
  </aside>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-header" style="background:#0b2557;color:#fff;">
      <h6 class="offcanvas-title"><i class="bi bi-building-check me-2"></i>Sombyo Admin</h6>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-3" style="background:#0b2557;">
      <nav class="nav flex-column gap-1">
        <a class="nav-link text-white" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a class="nav-link text-white" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
        <a class="nav-link active text-white" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
      </nav>
    </div>
  </div>

  <div class="content w-100">
    <nav class="navbar topbar">
      <div class="container-fluid px-3 px-lg-4">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-light d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
            <i class="bi bi-list"></i>
          </button>
          <span class="navbar-brand mb-0 h1 text-white">Account</span>
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-light d-flex align-items-center gap-2 dropdown-toggle" data-bs-toggle="dropdown">
            <span class="avatar" id="avatar">S</span>
            <span class="d-none d-sm-inline" id="who">Loading...</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" id="logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="content-wrap p-3 p-lg-4" style="max-width: 1100px;">
      <div class="row g-3">

        <div class="col-lg-5">
          <div class="card card-soft shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="mb-0"><i class="bi bi-person-badge me-2 text-primary"></i>My Account</h5>
                <span class="badge text-bg-primary" id="roleBadge"><i class="bi bi-shield-check me-1"></i>â€”</span>
              </div>

              <div class="alert alert-danger d-none" id="errBox"></div>
              <div class="alert alert-success d-none" id="okBox"></div>

              <div class="mt-3">
                <div class="mb-2"><span class="text-muted">Username:</span> <strong id="meUsername">-</strong></div>
                <div class="mb-2"><span class="text-muted">Email:</span> <strong id="meEmail">-</strong></div>
                <div class="mb-2"><span class="text-muted">Staff:</span> <strong id="meStaff">-</strong></div>
                <div class="mb-3"><span class="text-muted">Superuser:</span> <strong id="meSuper">-</strong></div>
              </div>

              <hr>

              <h6 class="mb-2"><i class="bi bi-person-gear me-2 text-primary"></i>Change Username</h6>
              <form id="usernameForm" class="mb-3">
                <div class="input-group mb-2">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input class="form-control" id="newUsername" placeholder="New username" required>
                </div>
                <button class="btn btn-primary btn-sm" type="submit">
                  <i class="bi bi-check2-circle me-1"></i> Update Username
                </button>
              </form>

              <h6 class="mb-2"><i class="bi bi-key me-2 text-primary"></i>Change Password</h6>
              <form id="passForm">
                <input class="form-control mb-2" id="oldPass" type="password" placeholder="Old password" required>
                <input class="form-control mb-2" id="newPass1" type="password" placeholder="New password" required>
                <input class="form-control mb-2" id="newPass2" type="password" placeholder="Repeat new password" required>
                <button class="btn btn-primary btn-sm" type="submit">
                  <i class="bi bi-check2-circle me-1"></i> Update Password
                </button>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card card-soft shadow-sm mb-3">
            <div class="card-body">
              <h5 class="mb-3"><i class="bi bi-person-plus me-2 text-primary"></i>Add New Admin (Superuser only)</h5>
              <div class="text-muted small mb-3">
                Ukiwa si superuser utapata 403. Hii ni ya kuongeza staff/admin wa kuona status za messages.
              </div>

              <form id="addAdminForm" class="row g-2">
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                    <input class="form-control" id="adminUsername" placeholder="Username" required>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                    <input class="form-control" id="adminEmail" placeholder="Email (optional)">
                  </div>
                </div>
                <div class="col-12">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-key"></i></span>
                    <input class="form-control" id="adminPassword" type="password" placeholder="Password" required>
                  </div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" type="submit">
                    <i class="bi bi-person-check me-1"></i> Create Admin
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="card card-soft shadow-sm">
            <div class="card-body">
              <h5 class="mb-3"><i class="bi bi-graph-up me-2 text-primary"></i>Quick Stats</h5>
              <div class="d-flex flex-wrap gap-3">
                <div><span class="text-muted">Total:</span> <strong id="sTotal">-</strong></div>
                <div><span class="text-muted">Unread:</span> <strong id="sUnread">-</strong></div>
                <div><span class="text-muted">Read:</span> <strong id="sRead">-</strong></div>
              </div>

              <div class="mt-3">
                <a class="btn btn-outline-primary" href="./messages.html">
                  <i class="bi bi-envelope-paper me-1"></i> Go to Messages
                </a>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://127.0.0.1:8000/api/contact";

function logout(){ localStorage.clear(); window.location.href="./login.html"; }

async function apiFetch(url, options = {}) {
  const access = localStorage.getItem("access");
  if (!access) { logout(); return; }

  options.headers = { ...(options.headers || {}), "Authorization": `Bearer ${access}` };
  let res = await fetch(url, options);

  if (res.status === 401) {
    const refresh = localStorage.getItem("refresh");
    const r = await fetch(`${API}/auth/refresh`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({refresh})
    });
    const rd = await r.json().catch(() => ({}));
    if (!r.ok) { logout(); return; }
    localStorage.setItem("access", rd.access);
    options.headers["Authorization"] = `Bearer ${rd.access}`;
    res = await fetch(url, options);
  }
  return res;
}

function initials(name){
  const n = (name||"").trim();
  if (!n) return "S";
  return n.slice(0,2).toUpperCase();
}

function showErr(msg){
  const e = document.getElementById("errBox");
  const o = document.getElementById("okBox");
  o.classList.add("d-none");
  e.textContent = msg;
  e.classList.remove("d-none");
}
function showOk(msg){
  const e = document.getElementById("errBox");
  const o = document.getElementById("okBox");
  e.classList.add("d-none");
  o.textContent = msg;
  o.classList.remove("d-none");
}

document.getElementById("logout").onclick = logout;

async function loadMe(){
  const r = await apiFetch(`${API}/admin/me`);
  const d = await r.json().catch(() => ({}));

  document.getElementById("who").textContent = d.username || "Admin";
  document.getElementById("avatar").textContent = initials(d.username);

  document.getElementById("meUsername").textContent = d.username || "-";
  document.getElementById("meEmail").textContent = d.email || "-";
  document.getElementById("meStaff").textContent = d.is_staff ? "Yes" : "No";
  document.getElementById("meSuper").textContent = d.is_superuser ? "Yes" : "No";

  document.getElementById("roleBadge").innerHTML = d.is_superuser
    ? `<i class="bi bi-shield-check me-1"></i>Superuser`
    : `<i class="bi bi-person-badge me-1"></i>Staff`;
}

async function loadStats(){
  const r = await apiFetch(`${API}/admin/stats`);
  const d = await r.json().catch(() => ({}));
  document.getElementById("sTotal").textContent = d.total ?? "-";
  document.getElementById("sUnread").textContent = d.unread ?? "-";
  document.getElementById("sRead").textContent = d.read ?? "-";
}

document.getElementById("usernameForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const username = document.getElementById("newUsername").value.trim();

  const r = await apiFetch(`${API}/admin/me/username`, {
    method: "PATCH",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({username})
  });

  const d = await r.json().catch(() => ({}));
  if (!r.ok) { showErr((d.username && d.username[0]) || d.detail || "Username update failed."); return; }

  showOk("Username updated successfully.");
  await loadMe();
});

document.getElementById("passForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = {
    old_password: document.getElementById("oldPass").value,
    new_password1: document.getElementById("newPass1").value,
    new_password2: document.getElementById("newPass2").value
  };

  const r = await apiFetch(`${API}/admin/me/password`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });

  const d = await r.json().catch(() => ({}));
  if (!r.ok) {
    const msg = (d.old_password && d.old_password[0]) || (d.new_password2 && d.new_password2[0]) || d.detail || "Password update failed.";
    showErr(msg);
    return;
  }

  showOk("Password updated. Login again if needed.");
  document.getElementById("passForm").reset();
});

document.getElementById("addAdminForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const body = {
    username: document.getElementById("adminUsername").value.trim(),
    email: document.getElementById("adminEmail").value.trim(),
    password: document.getElementById("adminPassword").value
  };

  const r = await apiFetch(`${API}/admin/users`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  });

  const d = await r.json().catch(() => ({}));
  if (!r.ok) {
    showErr(d.detail || (d.username && d.username[0]) || "Create admin failed.");
    return;
  }

  showOk(`Admin created: ${d.username}`);
  document.getElementById("addAdminForm").reset();
});

loadMe();
loadStats();
</script>
</body>
</html>
