<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Sombyo Admin - Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --sb-blue:#0d6efd;
      --sb-bg:#f6f8fb;
      --sb-side:#0b2557;
      --sb-card:#ffffff;
      --sb-radius:18px;
      --sb-shadow: 0 10px 25px rgba(11,37,87,.10);
    }

    body{ background: var(--sb-bg); }
    .app{ min-height:100vh; }
    .content{ flex: 1; }

    /* Desktop Sidebar */
    .sidebar{
      width: 260px;
      background: var(--sb-side);
      color: #fff;
    }
    .sidebar a{ color: rgba(255,255,255,.86); text-decoration:none; }
    .sidebar .nav-link{
      border-radius: 12px;
      padding: .6rem .75rem;
    }
    .sidebar .nav-link:hover{ background: rgba(255,255,255,.10); color:#fff; }
    .sidebar .nav-link.active{ background: rgba(13,110,253,.25); color:#fff; }

    /* Topbar */
    .topbar{
      background: linear-gradient(90deg, rgba(13,110,253,.95), rgba(11,94,215,.95));
      color: #fff;
    }

    /* Cards */
    .card-soft{
      border: 0;
      border-radius: var(--sb-radius);
      background: var(--sb-card);
      box-shadow: var(--sb-shadow);
    }
    .kpi{ border-left: 5px solid rgba(13,110,253,.35); }

    .avatar{
      width: 34px; height: 34px;
      border-radius: 50%;
      background: rgba(255,255,255,.2);
      display:flex; align-items:center; justify-content:center;
      font-weight: 700;
    }

    @media (min-width: 992px){
      .sidebar{ position: sticky; top: 0; height: 100vh; }
      .content-wrap{ padding: 22px; }
    }

    /* ===== Mobile App Feel ===== */
    @media (max-width: 991.98px){
      body{
        /* smaller fonts on mobile */
        font-size: 13px;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
      }

      .topbar .navbar-brand{ font-size: 16px !important; }
      .topbar .btn{ padding: .35rem .55rem; }
      .topbar .dropdown-toggle{ font-size: 13px; }

      .content-wrap{
        padding: 12px 12px calc(86px + env(safe-area-inset-bottom));
      }

      /* give "app shell" look */
      .mobile-shell{
        border-radius: 24px;
        background: rgba(255,255,255,.55);
        box-shadow: 0 18px 40px rgba(11,37,87,.10);
        padding: 12px;
      }

      /* tighter KPI */
      .card-soft .card-body{ padding: 14px; }
      .card-soft .text-muted{ font-size: 12px; }
      .kpi .fs-2{ font-size: 22px !important; }

      /* action buttons compact */
      .btn{
        border-radius: 14px;
      }
      .btn.btn-primary, .btn.btn-outline-primary{
        padding: .55rem .8rem;
        font-size: 13px;
      }
    }

    /* Bottom Nav (mobile only) */
    .bottom-nav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,.06);
      z-index: 1050;
    }
    .bottom-nav .nav{
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .bottom-nav a{
      flex: 1;
      text-decoration: none;
      color: #2b3a55;
      border-radius: 16px;
      padding: 10px 8px;
      text-align: center;
      font-size: 12px;
      background: rgba(13,110,253,.06);
      border: 1px solid rgba(13,110,253,.08);
    }
    .bottom-nav a.active{
      background: rgba(13,110,253,.14);
      border-color: rgba(13,110,253,.22);
      color: #0b3d91;
      font-weight: 600;
    }
    .bottom-nav i{ display:block; font-size: 18px; margin-bottom: 4px; }
    @media (min-width: 992px){
      .bottom-nav{ display:none; }
    }
  </style>
</head>

<body>
<div class="app d-flex">

  <!-- Desktop Sidebar -->
  <aside class="sidebar d-none d-lg-block p-3">
    <div class="d-flex align-items-center gap-2 mb-3">
      <div class="p-2 rounded-3" style="background:rgba(255,255,255,.12)">
        <i class="bi bi-building-check"></i>
      </div>
      <div>
        <div class="fw-semibold">Sombyo Admin</div>
        <div class="small opacity-75">Dashboard</div>
      </div>
    </div>

    <nav class="nav flex-column gap-1 mt-3">
      <a class="nav-link active" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
      <a class="nav-link" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
      <a class="nav-link" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
    </nav>
  </aside>

  <!-- Mobile Offcanvas Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header" style="background:#0b2557;color:#fff;">
      <h6 class="offcanvas-title" id="mobileSidebarLabel"><i class="bi bi-building-check me-2"></i>Sombyo Admin</h6>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-3" style="background:#0b2557;">
      <nav class="nav flex-column gap-1">
        <a class="nav-link active text-white" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a class="nav-link text-white" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
        <a class="nav-link text-white" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content w-100">
    <nav class="navbar topbar">
      <div class="container-fluid px-3 px-lg-4">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-light d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
            <i class="bi bi-list"></i>
          </button>
          <span class="navbar-brand mb-0 h1 text-white">Dashboard</span>
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-light d-flex align-items-center gap-2 dropdown-toggle" data-bs-toggle="dropdown">
            <span class="avatar" id="avatar">S</span>
            <span class="d-none d-sm-inline" id="who">Loading...</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="./account.html"><i class="bi bi-person-gear me-2"></i>Account</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" id="logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="content-wrap p-3 p-lg-4">
      <!-- mobile shell wrapper (gives app feel) -->
      <div class="mobile-shell">

        <div class="row g-3">
          <div class="col-md-4">
            <div class="card card-soft kpi">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="text-muted">Total Messages</div>
                    <div class="fs-2 fw-bold" id="total">-</div>
                  </div>
                  <div class="fs-2 text-primary"><i class="bi bi-inboxes"></i></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-soft kpi">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="text-muted">Unread</div>
                    <div class="fs-2 fw-bold" id="unread">-</div>
                  </div>
                  <div class="fs-2 text-warning"><i class="bi bi-envelope-exclamation"></i></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card card-soft kpi">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="text-muted">Read</div>
                    <div class="fs-2 fw-bold" id="read">-</div>
                  </div>
                  <div class="fs-2 text-success"><i class="bi bi-envelope-check"></i></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-3 mt-lg-4 d-flex flex-wrap gap-2">
          <a class="btn btn-primary" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i>Open Messages</a>
          <a class="btn btn-outline-primary" href="./account.html"><i class="bi bi-gear me-2"></i>Account Settings</a>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Mobile Bottom Nav -->
<div class="bottom-nav">
  <div class="nav">
    <a class="active" href="./dashboard.html"><i class="bi bi-speedometer2"></i>Dashboard</a>
    <a href="./messages.html"><i class="bi bi-envelope-paper"></i>Messages</a>
    <a href="./account.html"><i class="bi bi-gear"></i>Account</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://127.0.0.1:8000/api/contact";

function logout() {
  localStorage.clear();
  window.location.href = "./login.html";
}

async function apiFetch(url, options = {}) {
  const access = localStorage.getItem("access");
  if (!access) { logout(); return; }

  options.headers = { ...(options.headers || {}), "Authorization": `Bearer ${access}` };
  let res = await fetch(url, { ...options, cache: "no-store" });

  if (res.status === 401) {
    const refresh = localStorage.getItem("refresh");
    const r = await fetch(`${API}/auth/refresh`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({refresh}),
      cache: "no-store"
    });
    const rd = await r.json().catch(() => ({}));
    if (!r.ok) { logout(); return; }
    localStorage.setItem("access", rd.access);
    options.headers["Authorization"] = `Bearer ${rd.access}`;
    res = await fetch(url, { ...options, cache: "no-store" });
  }
  return res;
}

function initials(name){
  const n = (name || "").trim();
  if (!n) return "S";
  return n.slice(0,2).toUpperCase();
}

document.getElementById("logout").onclick = logout;

(async () => {
  const meRes = await apiFetch(`${API}/admin/me`);
  const me = await meRes.json().catch(() => ({}));
  document.getElementById("who").textContent = me.username || "Admin";
  document.getElementById("avatar").textContent = initials(me.username);

  const res = await apiFetch(`${API}/admin/stats`);
  const data = await res.json().catch(() => ({}));
  document.getElementById("total").textContent = data.total ?? "-";
  document.getElementById("unread").textContent = data.unread ?? "-";
  document.getElementById("read").textContent = data.read ?? "-";
})();
</script>
</body>
</html>
