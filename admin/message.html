<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sombyo Admin - Message</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{ --sb-blue:#0d6efd; --sb-bg:#f6f8fb; }
    body{ background: var(--sb-bg); }
    .app{ min-height:100vh; }
    .sidebar{ width:260px; background:#0b2557; color:#fff; }
    .sidebar .nav-link{ color:rgba(255,255,255,.86); border-radius:12px; padding:.6rem .75rem; }
    .sidebar .nav-link:hover{ background:rgba(255,255,255,.10); color:#fff; }
    .sidebar .nav-link.active{ background:rgba(13,110,253,.25); color:#fff; }
    .topbar{ background: linear-gradient(90deg, rgba(13,110,253,.95), rgba(11,94,215,.95)); color:#fff; }
    .card-soft{ border:0; border-radius:18px; }
    .avatar{
      width:34px;height:34px;border-radius:50%;
      background:rgba(255,255,255,.2);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
    }
    @media (min-width:992px){
      .sidebar{ position:sticky; top:0; height:100vh; }
      .content-wrap{ padding:22px; }
    }
    .msg-body{ white-space: pre-wrap; }
  </style>
</head>

<body>
<div class="app d-flex">

  <aside class="sidebar d-none d-lg-block p-3">
    <div class="d-flex align-items-center gap-2 mb-3">
      <div class="p-2 rounded-3" style="background:rgba(255,255,255,.12)">
        <i class="bi bi-eye"></i>
      </div>
      <div>
        <div class="fw-semibold">Sombyo Admin</div>
        <div class="small opacity-75">Message</div>
      </div>
    </div>

    <nav class="nav flex-column gap-1 mt-3">
      <a class="nav-link" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
      <a class="nav-link active" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
      <a class="nav-link" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
    </nav>
  </aside>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
    <div class="offcanvas-header" style="background:#0b2557;color:#fff;">
      <h6 class="offcanvas-title"><i class="bi bi-building-check me-2"></i>Sombyo Admin</h6>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-3" style="background:#0b2557;">
      <nav class="nav flex-column gap-1">
        <a class="nav-link text-white" href="./dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a class="nav-link active text-white" href="./messages.html"><i class="bi bi-envelope-paper me-2"></i> Messages</a>
        <a class="nav-link text-white" href="./account.html"><i class="bi bi-gear me-2"></i> Account</a>
      </nav>
    </div>
  </div>

  <div class="content w-100">
    <nav class="navbar topbar">
      <div class="container-fluid px-3 px-lg-4">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-light d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
            <i class="bi bi-list"></i>
          </button>
          <span class="navbar-brand mb-0 h1 text-white">Read Message</span>
        </div>

        <div class="dropdown">
          <button class="btn btn-outline-light d-flex align-items-center gap-2 dropdown-toggle" data-bs-toggle="dropdown">
            <span class="avatar" id="avatar">S</span>
            <span class="d-none d-sm-inline" id="who">Loading...</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="./account.html"><i class="bi bi-person-gear me-2"></i>Account</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><button class="dropdown-item text-danger" id="logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="content-wrap p-3 p-lg-4">
      <div class="d-flex flex-wrap gap-2 mb-3">
        <a class="btn btn-outline-primary" href="./messages.html">
          <i class="bi bi-arrow-left me-1"></i> Back to Messages
        </a>
        <button class="btn btn-primary" id="refreshBtn">
          <i class="bi bi-arrow-clockwise me-1"></i> Refresh
        </button>
        <button class="btn btn-outline-warning" id="markUnreadBtn">
          <i class="bi bi-arrow-counterclockwise me-1"></i> Mark Unread
        </button>
        <a class="btn btn-outline-secondary" id="mailtoBtn" href="#" target="_blank">
          <i class="bi bi-reply me-1"></i> Reply (Email)
        </a>
      </div>

      <div class="alert alert-danger d-none" id="errBox"></div>

      <div class="card card-soft shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
            <div>
              <div class="text-muted small">Subject</div>
              <h5 class="mb-1" id="subject">—</h5>
              <div class="text-muted small" id="meta">—</div>
            </div>
            <div id="statusBadge">—</div>
          </div>

          <hr>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="text-muted small">From</div>
              <div class="fw-semibold" id="fromName">—</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Email</div>
              <div class="fw-semibold" id="fromEmail">—</div>
            </div>
          </div>

          <hr>

          <div class="text-muted small mb-2">Message</div>
          <div class="msg-body" id="message">—</div>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API = "http://127.0.0.1:8000/api/contact";

function logout(){ localStorage.clear(); window.location.href="./login.html"; }

async function apiFetch(url, options = {}) {
  const access = localStorage.getItem("access");
  if (!access) { logout(); return; }

  options.headers = { ...(options.headers || {}), "Authorization": `Bearer ${access}` };
  let res = await fetch(url, options);

  if (res.status === 401) {
    const refresh = localStorage.getItem("refresh");
    const r = await fetch(`${API}/auth/refresh`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({refresh})
    });
    const rd = await r.json().catch(() => ({}));
    if (!r.ok) { logout(); return; }
    localStorage.setItem("access", rd.access);
    options.headers["Authorization"] = `Bearer ${rd.access}`;
    res = await fetch(url, options);
  }
  return res;
}

function initials(name){
  const n = (name||"").trim();
  if (!n) return "S";
  return n.slice(0,2).toUpperCase();
}

document.getElementById("logout").onclick = logout;

async function loadMe(){
  const r = await apiFetch(`${API}/admin/me`);
  const d = await r.json().catch(() => ({}));
  document.getElementById("who").textContent = d.username || "Admin";
  document.getElementById("avatar").textContent = initials(d.username);
}

function getId(){
  const u = new URL(window.location.href);
  return u.searchParams.get("id");
}

function setErr(msg){
  const e = document.getElementById("errBox");
  e.textContent = msg;
  e.classList.remove("d-none");
}

function fmt(dt){
  if (!dt) return "-";
  return String(dt).replace("T"," ").replace("Z","");
}

async function loadMessage(){
  const id = getId();
  if (!id) { setErr("Missing message id."); return; }

  document.getElementById("errBox").classList.add("d-none");

  const r = await apiFetch(`${API}/admin/messages/${id}`);
  const m = await r.json().catch(() => ({}));
  if (!r.ok) { setErr(m.detail || "Failed to load message."); return; }

  // Backend already marks read on open (if unread)
  document.getElementById("subject").textContent = m.subject || "-";
  document.getElementById("meta").textContent =
    `Created: ${fmt(m.created_at)}  •  Read: ${m.is_read ? "Yes" : "No"} ${m.read_at ? " • Read at: " + fmt(m.read_at) : ""}`;

  document.getElementById("fromName").textContent = m.name || "-";
  document.getElementById("fromEmail").textContent = m.email || "-";
  document.getElementById("message").textContent = m.message || "-";

  document.getElementById("statusBadge").innerHTML = m.is_read
    ? `<span class="badge text-bg-success"><i class="bi bi-envelope-check me-1"></i>Read</span>`
    : `<span class="badge text-bg-warning"><i class="bi bi-envelope-exclamation me-1"></i>Unread</span>`;

  const mailto = `mailto:${encodeURIComponent(m.email || "")}?subject=${encodeURIComponent("Re: " + (m.subject || ""))}`;
  document.getElementById("mailtoBtn").href = mailto;
}

document.getElementById("refreshBtn").onclick = loadMessage;

document.getElementById("markUnreadBtn").onclick = async () => {
  const id = getId();
  if (!id) return;
  await apiFetch(`${API}/admin/messages/${id}/unread`, { method: "POST" });
  await loadMessage();
};

loadMe();
loadMessage();
</script>
</body>
</html>
